name: Build Nanobot Snapshot

on:
  workflow_dispatch:

jobs:
  build-snapshot:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout (for commit info)
        uses: actions/checkout@v4

      - name: Get version info
        id: version
        run: |
          COMMIT=$(git rev-parse --short HEAD)
          FULL_COMMIT=$(git rev-parse HEAD)
          TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          VERSION="${TAG:-v0.0.0}-${COMMIT}"
          echo "commit=$COMMIT" >> "$GITHUB_OUTPUT"
          echo "full_commit=$FULL_COMMIT" >> "$GITHUB_OUTPUT"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "Version: $VERSION (commit: $COMMIT)"

      - name: Create temp droplet
        id: create
        run: |
          RESPONSE=$(curl -sS -X POST "https://api.digitalocean.com/v2/droplets" \
            -H "Authorization: Bearer ${{ secrets.DO_API_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{
              "name": "nanobot-snapshot-builder",
              "region": "nyc1",
              "size": "s-2vcpu-2gb",
              "image": "ubuntu-24-04-x64",
              "ssh_keys": [],
              "user_data": "#!/bin/bash\nset -euo pipefail\napt-get update\napt-get install -y python3-pip python3-venv git ufw\npython3 -m venv /opt/nanobot\n/opt/nanobot/bin/pip install --upgrade pip\ncd /opt && git clone https://github.com/Tanic-Labs/nanobot.git nanobot-src\n/opt/nanobot/bin/pip install -e /opt/nanobot-src\nmkdir -p /root/.nanobot/memory /root/.nanobot/workspace\necho '${{ steps.version.outputs.version }}' > /opt/nanobot-src/.version\ncat > /etc/systemd/system/nanobot.service << SERVICEEOF\n[Unit]\nDescription=nanobot AI Agent\nAfter=network.target\n\n[Service]\nType=simple\nExecStart=/opt/nanobot/bin/nanobot gateway\nWorkingDirectory=/root/.nanobot\nRestart=always\nRestartSec=5\nEnvironment=HOME=/root\n\n[Install]\nWantedBy=multi-user.target\nSERVICEEOF\nufw allow 22/tcp\nufw allow 3015/tcp\nufw allow 18791/tcp\nufw --force enable\nsystemctl daemon-reload\nsystemctl enable nanobot\ntouch /tmp/nanobot-setup-done",
              "tags": ["snapshot-builder"]
            }')
          DROPLET_ID=$(echo "$RESPONSE" | jq -r '.droplet.id')
          echo "droplet_id=$DROPLET_ID" >> "$GITHUB_OUTPUT"
          echo "Created droplet $DROPLET_ID"

      - name: Wait for droplet to be active
        run: |
          DROPLET_ID=${{ steps.create.outputs.droplet_id }}
          for i in $(seq 1 60); do
            STATUS=$(curl -sS "https://api.digitalocean.com/v2/droplets/$DROPLET_ID" \
              -H "Authorization: Bearer ${{ secrets.DO_API_TOKEN }}" | jq -r '.droplet.status')
            echo "Attempt $i: status=$STATUS"
            if [ "$STATUS" = "active" ]; then break; fi
            sleep 10
          done

      - name: Wait for cloud-init to finish
        run: |
          # Wait up to 8 minutes for setup to complete
          for i in $(seq 1 48); do
            echo "Waiting for setup... attempt $i/48"
            sleep 10
          done

      - name: Power off droplet
        run: |
          DROPLET_ID=${{ steps.create.outputs.droplet_id }}
          curl -sS -X POST "https://api.digitalocean.com/v2/droplets/$DROPLET_ID/actions" \
            -H "Authorization: Bearer ${{ secrets.DO_API_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{"type": "power_off"}'
          for i in $(seq 1 30); do
            STATUS=$(curl -sS "https://api.digitalocean.com/v2/droplets/$DROPLET_ID" \
              -H "Authorization: Bearer ${{ secrets.DO_API_TOKEN }}" | jq -r '.droplet.status')
            echo "Attempt $i: status=$STATUS"
            if [ "$STATUS" = "off" ]; then break; fi
            sleep 5
          done

      - name: Create snapshot
        id: snapshot
        run: |
          DROPLET_ID=${{ steps.create.outputs.droplet_id }}
          VERSION=${{ steps.version.outputs.version }}
          SNAP_NAME="nanobot-${VERSION}"
          RESPONSE=$(curl -sS -X POST "https://api.digitalocean.com/v2/droplets/$DROPLET_ID/actions" \
            -H "Authorization: Bearer ${{ secrets.DO_API_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d "{\"type\": \"snapshot\", \"name\": \"$SNAP_NAME\"}")
          ACTION_ID=$(echo "$RESPONSE" | jq -r '.action.id')
          echo "Snapshot action $ACTION_ID started ($SNAP_NAME)"
          for i in $(seq 1 60); do
            STATUS=$(curl -sS "https://api.digitalocean.com/v2/actions/$ACTION_ID" \
              -H "Authorization: Bearer ${{ secrets.DO_API_TOKEN }}" | jq -r '.action.status')
            echo "Attempt $i: status=$STATUS"
            if [ "$STATUS" = "completed" ]; then break; fi
            sleep 10
          done
          SNAPSHOT_ID=$(curl -sS "https://api.digitalocean.com/v2/droplets/$DROPLET_ID/snapshots" \
            -H "Authorization: Bearer ${{ secrets.DO_API_TOKEN }}" | \
            jq -r ".snapshots[] | select(.name==\"$SNAP_NAME\") | .id")
          echo "snapshot_id=$SNAPSHOT_ID" >> "$GITHUB_OUTPUT"
          echo "snapshot_name=$SNAP_NAME" >> "$GITHUB_OUTPUT"
          echo "Created snapshot $SNAPSHOT_ID ($SNAP_NAME)"

      - name: Update Supabase platform_config
        run: |
          SNAPSHOT_ID=${{ steps.snapshot.outputs.snapshot_id }}
          VERSION=${{ steps.version.outputs.version }}
          COMMIT=${{ steps.version.outputs.full_commit }}
          NOW=$(date -u +%Y-%m-%dT%H:%M:%SZ)

          # Update snapshot ID
          curl -sS -X PATCH "${{ secrets.SUPABASE_URL }}/rest/v1/platform_config?key=eq.nanobot_base_snapshot" \
            -H "apikey: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
            -H "Content-Type: application/json" \
            -d "{\"value\": \"$SNAPSHOT_ID\", \"updated_at\": \"$NOW\"}"

          # Upsert version
          curl -sS -X POST "${{ secrets.SUPABASE_URL }}/rest/v1/platform_config" \
            -H "apikey: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
            -H "Content-Type: application/json" \
            -H "Prefer: resolution=merge-duplicates" \
            -d "{\"key\": \"nanobot_version\", \"value\": \"$VERSION\", \"updated_at\": \"$NOW\"}"

          # Upsert commit
          curl -sS -X POST "${{ secrets.SUPABASE_URL }}/rest/v1/platform_config" \
            -H "apikey: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
            -H "Content-Type: application/json" \
            -H "Prefer: resolution=merge-duplicates" \
            -d "{\"key\": \"nanobot_commit\", \"value\": \"$COMMIT\", \"updated_at\": \"$NOW\"}"

          echo "Updated: snapshot=$SNAPSHOT_ID, version=$VERSION, commit=$COMMIT"

      - name: Destroy temp droplet
        if: always()
        run: |
          DROPLET_ID=${{ steps.create.outputs.droplet_id }}
          if [ -n "$DROPLET_ID" ] && [ "$DROPLET_ID" != "null" ]; then
            curl -sS -X DELETE "https://api.digitalocean.com/v2/droplets/$DROPLET_ID" \
              -H "Authorization: Bearer ${{ secrets.DO_API_TOKEN }}"
            echo "Destroyed temp droplet $DROPLET_ID"
          fi

      - name: Summary
        run: |
          echo "## Snapshot Build Complete" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ steps.version.outputs.full_commit }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Snapshot ID:** ${{ steps.snapshot.outputs.snapshot_id }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Snapshot Name:** ${{ steps.snapshot.outputs.snapshot_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Supabase \`platform_config\` updated with snapshot ID, version, and commit." >> $GITHUB_STEP_SUMMARY

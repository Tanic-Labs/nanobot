<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>nanobot</title>
<style>
  :root {
    --bg: #0a0a0a;
    --surface: #141414;
    --border: #262626;
    --text: #e5e5e5;
    --text-dim: #737373;
    --accent: #3b82f6;
    --accent-hover: #2563eb;
    --user-bg: #1e3a5f;
    --bot-bg: #1a1a1a;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
    background: var(--bg);
    color: var(--text);
    height: 100dvh;
    display: flex;
    flex-direction: column;
  }

  header {
    padding: 12px 20px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 10px;
    background: var(--surface);
  }

  header .logo { font-size: 20px; }
  header h1 { font-size: 16px; font-weight: 600; }
  header .status {
    margin-left: auto;
    font-size: 12px;
    color: var(--text-dim);
    display: flex;
    align-items: center;
    gap: 6px;
  }
  header .status .dot {
    width: 8px; height: 8px;
    border-radius: 50%;
    background: #ef4444;
  }
  header .status .dot.connected { background: #22c55e; }

  #messages {
    flex: 1;
    overflow-y: auto;
    padding: 16px 20px;
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .msg {
    max-width: 75%;
    padding: 10px 14px;
    border-radius: 12px;
    font-size: 14px;
    line-height: 1.5;
    word-wrap: break-word;
    white-space: pre-wrap;
  }

  .msg.user {
    align-self: flex-end;
    background: var(--user-bg);
    border-bottom-right-radius: 4px;
  }

  .msg.bot {
    align-self: flex-start;
    background: var(--bot-bg);
    border: 1px solid var(--border);
    border-bottom-left-radius: 4px;
  }

  .msg.bot code {
    background: #262626;
    padding: 1px 5px;
    border-radius: 4px;
    font-size: 13px;
  }

  .msg.bot pre {
    background: #1e1e1e;
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 10px;
    overflow-x: auto;
    margin: 6px 0;
  }

  .msg.bot pre code {
    background: none;
    padding: 0;
    font-size: 13px;
  }

  .typing {
    align-self: flex-start;
    color: var(--text-dim);
    font-size: 13px;
    padding: 6px 0;
  }

  .typing span {
    animation: blink 1.4s infinite;
  }
  .typing span:nth-child(2) { animation-delay: 0.2s; }
  .typing span:nth-child(3) { animation-delay: 0.4s; }

  @keyframes blink {
    0%, 60%, 100% { opacity: 0.2; }
    30% { opacity: 1; }
  }

  #input-area {
    padding: 12px 20px;
    border-top: 1px solid var(--border);
    background: var(--surface);
  }

  #input-area form {
    display: flex;
    gap: 8px;
  }

  #input-area textarea {
    flex: 1;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 10px 14px;
    color: var(--text);
    font-size: 14px;
    font-family: inherit;
    resize: none;
    outline: none;
    min-height: 42px;
    max-height: 120px;
  }

  #input-area textarea:focus { border-color: var(--accent); }
  #input-area textarea::placeholder { color: var(--text-dim); }

  #input-area button {
    background: var(--accent);
    border: none;
    border-radius: 10px;
    padding: 0 16px;
    color: #fff;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: background 0.15s;
  }

  #input-area button:hover { background: var(--accent-hover); }
  #input-area button:disabled { opacity: 0.4; cursor: default; }

  @media (max-width: 600px) {
    .msg { max-width: 90%; }
  }
</style>
</head>
<body>
  <header>
    <span class="logo">&#128008;</span>
    <h1>nanobot</h1>
    <div class="status">
      <span class="dot" id="status-dot"></span>
      <span id="status-text">Disconnected</span>
    </div>
  </header>

  <div id="messages"></div>

  <div id="input-area">
    <form id="chat-form">
      <textarea id="chat-input" placeholder="Type a message..." rows="1"></textarea>
      <button type="submit" id="send-btn" disabled>Send</button>
    </form>
  </div>

<script>
  const messagesEl = document.getElementById('messages');
  const form = document.getElementById('chat-form');
  const input = document.getElementById('chat-input');
  const sendBtn = document.getElementById('send-btn');
  const statusDot = document.getElementById('status-dot');
  const statusText = document.getElementById('status-text');

  let ws = null;
  let typingEl = null;
  let sessionId = null;

  function connect() {
    const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
    ws = new WebSocket(`${proto}//${location.host}`);

    ws.onopen = () => {
      statusDot.classList.add('connected');
      statusText.textContent = 'Connected';
      sendBtn.disabled = false;
    };

    ws.onclose = () => {
      statusDot.classList.remove('connected');
      statusText.textContent = 'Disconnected';
      sendBtn.disabled = true;
      setTimeout(connect, 2000);
    };

    ws.onerror = () => ws.close();

    ws.onmessage = (e) => {
      const data = JSON.parse(e.data);

      if (data.type === 'connected') {
        sessionId = data.session_id;
        return;
      }

      if (data.type === 'typing') {
        showTyping();
        return;
      }

      if (data.type === 'message') {
        hideTyping();
        addMessage(data.content, 'bot');
      }
    };
  }

  function addMessage(text, role) {
    const el = document.createElement('div');
    el.className = `msg ${role}`;
    if (role === 'bot') {
      el.innerHTML = renderMarkdown(text);
    } else {
      el.textContent = text;
    }
    messagesEl.appendChild(el);
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }

  function showTyping() {
    if (typingEl) return;
    typingEl = document.createElement('div');
    typingEl.className = 'typing';
    typingEl.innerHTML = '<span>.</span><span>.</span><span>.</span> thinking';
    messagesEl.appendChild(typingEl);
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }

  function hideTyping() {
    if (typingEl) { typingEl.remove(); typingEl = null; }
  }

  function renderMarkdown(text) {
    // Code blocks
    text = text.replace(/```(\w*)\n?([\s\S]*?)```/g, (_, lang, code) => {
      const escaped = code.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
      return `<pre><code>${escaped}</code></pre>`;
    });
    // Inline code
    text = text.replace(/`([^`]+)`/g, (_, code) => {
      const escaped = code.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
      return `<code>${escaped}</code>`;
    });
    // Bold
    text = text.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
    // Italic
    text = text.replace(/(?<![a-zA-Z0-9])_([^_]+)_(?![a-zA-Z0-9])/g, '<em>$1</em>');
    // Links
    text = text.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" style="color:var(--accent)">$1</a>');
    // Bullet lists
    text = text.replace(/^[-*]\s+(.+)$/gm, '&bull; $1');
    return text;
  }

  // Auto-resize textarea
  input.addEventListener('input', () => {
    input.style.height = 'auto';
    input.style.height = Math.min(input.scrollHeight, 120) + 'px';
  });

  // Send on Enter (Shift+Enter for newline)
  input.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      form.dispatchEvent(new Event('submit'));
    }
  });

  form.addEventListener('submit', (e) => {
    e.preventDefault();
    const text = input.value.trim();
    if (!text || !ws || ws.readyState !== WebSocket.OPEN) return;

    addMessage(text, 'user');
    ws.send(JSON.stringify({ type: 'message', content: text }));

    input.value = '';
    input.style.height = 'auto';
  });

  connect();
</script>
</body>
</html>
